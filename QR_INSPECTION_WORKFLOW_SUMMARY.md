# QR 스캔 → 점검 워크플로우 완료 요약

**작성일**: 2025-12-02 16:41
**상태**: ✅ Phase 2 완료

---

## 🎉 구현 완료 항목

### 1. QR 스캔 시스템
- ✅ **파일**: `client/src/api/qrApi.ts`
- ✅ **기능**:
  - QR 코드 스캔 및 세션 생성
  - 금형 정보 조회
  - 역할별 가능한 작업 목록 반환
  - GPS 위치 이탈 알림

### 2. 점검 API 클라이언트
- ✅ **파일**: `client/src/api/inspectionApi.ts`
- ✅ **기능**:
  - 일상점검 제출
  - 정기점검 제출 (20K/100K/400K/800K)
  - 백엔드 페이로드 구조 정확히 매핑

### 3. QR 스캔 페이지
- ✅ **파일**: `client/src/pages/qr/QrScanPage.tsx`
- ✅ **경로**: `/qr/scan`
- ✅ **기능**:
  - QR 코드 입력 폼
  - 실시간 세션 생성
  - 금형 정보 표시 (코드, 이름, 상태, 생산처)
  - 가능한 작업 버튼 (일상점검, 정기점검, 수리요청)
  - 위치 이탈 경고 표시

### 4. 일상점검 페이지
- ✅ **파일**: `client/src/pages/qr/DailyInspectionPage.tsx`
- ✅ **경로**: `/qr/daily-inspection/:sessionId?moldId=X`
- ✅ **기능**:
  - 생산수량 입력
  - NG 수량 입력
  - 특이사항 메모
  - 백엔드 API 호출
  - 금형 타수 자동 업데이트

### 5. 정기점검 페이지
- ✅ **파일**: `client/src/pages/qr/PeriodicInspectionPage.tsx`
- ✅ **경로**: `/qr/periodic-inspection/:sessionId?moldId=X`
- ✅ **기능**:
  - 점검 주기 선택 (20K/100K/400K/800K)
  - 측정값 입력
  - 기준값 (min/max) 입력
  - 서버에서 NG 자동 판정

### 6. 라우터 통합
- ✅ **파일**: `client/src/App.jsx`
- ✅ **라우트**:
  - `/qr/scan` - QR 스캔 페이지
  - `/qr/daily-inspection/:sessionId` - 일상점검
  - `/qr/periodic-inspection/:sessionId` - 정기점검
- ✅ **보호**: ProtectedRoute로 인증 필요

---

## 🔄 완전한 워크플로우

```
┌─────────────────────────────────────────────────────────────┐
│ 1. 사용자 로그인 (역할별)                                      │
│    - system_admin / mold_developer / maker / plant           │
└─────────────────┬───────────────────────────────────────────┘
                  │
                  ▼
┌─────────────────────────────────────────────────────────────┐
│ 2. 역할별 대시보드 진입                                        │
│    - /dashboard/admin, /dashboard/plant, etc.               │
└─────────────────┬───────────────────────────────────────────┘
                  │
                  ▼
┌─────────────────────────────────────────────────────────────┐
│ 3. QR 스캔 페이지 이동                                         │
│    - 메뉴/버튼 클릭 → /qr/scan                                │
└─────────────────┬───────────────────────────────────────────┘
                  │
                  ▼
┌─────────────────────────────────────────────────────────────┐
│ 4. QR 코드 입력/스캔                                           │
│    - 예: M2024-001-PLANT-A-QR                                │
│    - POST /api/v1/qr/scan                                    │
└─────────────────┬───────────────────────────────────────────┘
                  │
                  ▼
┌─────────────────────────────────────────────────────────────┐
│ 5. 세션 생성 및 금형 정보 표시                                 │
│    - sessionId: sess_abc123                                  │
│    - 금형 코드: M2024-001                                     │
│    - 상태: in_production                                     │
│    - 생산처: 부산 1공장                                        │
│    - 위치 알림: 정상 범위 내                                   │
└─────────────────┬───────────────────────────────────────────┘
                  │
                  ▼
┌─────────────────────────────────────────────────────────────┐
│ 6. 가능한 작업 선택                                            │
│    ┌──────────────────┬──────────────────┬─────────────────┐│
│    │ 일상점검 작성      │ 정기점검 작성      │ 수리요청 작성    ││
│    │ daily_inspection │ periodic_insp... │ create_repair...││
│    └──────────────────┴──────────────────┴─────────────────┘│
└─────────────────┬───────────────────────────────────────────┘
                  │
                  ▼
┌─────────────────────────────────────────────────────────────┐
│ 7a. 일상점검 작성                                              │
│     - /qr/daily-inspection/sess_abc123?moldId=1              │
│     - 생산수량: 1000                                          │
│     - NG 수량: 5                                              │
│     - 메모: "게이트 주변 번짐"                                 │
│     - POST /api/v1/inspections/daily                         │
└─────────────────┬───────────────────────────────────────────┘
                  │
                  ▼
┌─────────────────────────────────────────────────────────────┐
│ 8a. 백엔드 처리 (일상점검)                                     │
│     - 금형 타수 +1000 shot                                    │
│     - NG 수량 누적                                            │
│     - 점검 이력 저장                                          │
│     - QR 세션 종료                                            │
└─────────────────┬───────────────────────────────────────────┘
                  │
                  ▼
┌─────────────────────────────────────────────────────────────┐
│ 9a. 성공 메시지 및 리다이렉트                                  │
│     - "일상점검이 저장되었습니다"                              │
│     - 1.2초 후 이전 화면으로                                   │
└─────────────────────────────────────────────────────────────┘

                  OR

┌─────────────────────────────────────────────────────────────┐
│ 7b. 정기점검 작성                                              │
│     - /qr/periodic-inspection/sess_abc123?moldId=1           │
│     - 주기: 20K                                               │
│     - 측정값: 15.5                                            │
│     - 최소값: 15.0, 최대값: 16.0                              │
│     - POST /api/v1/inspections/periodic                      │
└─────────────────┬───────────────────────────────────────────┘
                  │
                  ▼
┌─────────────────────────────────────────────────────────────┐
│ 8b. 백엔드 처리 (정기점검)                                     │
│     - 측정값 vs 기준값 비교                                    │
│     - NG 자동 판정 (15.0 ≤ 15.5 ≤ 16.0 → OK)                 │
│     - Critical NG 체크                                        │
│     - 점검 이력 저장                                          │
│     - 필요시 알림 생성                                         │
└─────────────────┬───────────────────────────────────────────┘
                  │
                  ▼
┌─────────────────────────────────────────────────────────────┐
│ 9b. 성공 메시지 및 리다이렉트                                  │
│     - "20K 정기점검이 저장되었습니다"                          │
│     - 1.2초 후 이전 화면으로                                   │
└─────────────────────────────────────────────────────────────┘
```

---

## 📡 API 연동 상세

### 1. QR 스캔 API

**엔드포인트**: `POST /api/v1/qr/scan`

**요청**:
```json
{
  "qr_code": "M2024-001-PLANT-A-QR"
}
```

**응답**:
```json
{
  "success": true,
  "data": {
    "sessionId": "sess_abc123",
    "mold": {
      "id": 1,
      "code": "M2024-001",
      "name": "엔진 커버 금형",
      "status": "in_production",
      "plantName": "부산 1공장"
    },
    "availableActions": [
      "daily_inspection",
      "periodic_inspection",
      "create_repair_request"
    ],
    "locationAlert": {
      "isOutOfRange": false,
      "distanceKm": 0.5
    }
  }
}
```

### 2. 일상점검 API

**엔드포인트**: `POST /api/v1/inspections/daily`

**요청**:
```json
{
  "session_id": "sess_abc123",
  "mold_id": 1,
  "production_quantity": 1000,
  "ng_quantity": 5,
  "checklist_items": [],
  "notes": "게이트 주변 번짐"
}
```

**응답**:
```json
{
  "success": true,
  "data": {
    "dailyCheck": {
      "id": 123,
      "mold_id": 1,
      "production_quantity": 1000,
      "ng_quantity": 5
    },
    "moldUpdated": {
      "current_shots": 45000,
      "total_ng_count": 125
    }
  }
}
```

### 3. 정기점검 API

**엔드포인트**: `POST /api/v1/inspections/periodic`

**요청**:
```json
{
  "session_id": "sess_abc123",
  "mold_id": 1,
  "inspection_type": "20K",
  "checklist_items": [{
    "question_id": 1,
    "answer": "15.5",
    "measured_value": 15.5,
    "spec_min": 15.0,
    "spec_max": 16.0
  }],
  "notes": "정상 범위 내"
}
```

**응답**:
```json
{
  "success": true,
  "data": {
    "inspection": {
      "id": 456,
      "mold_id": 1,
      "inspection_type": "20K",
      "overall_result": "OK"
    },
    "ngDetected": false,
    "criticalNg": false
  }
}
```

---

## 🎯 역할별 가능한 작업

| 역할 | 일상점검 | 정기점검 | 수리요청 | TRIAL 체크 |
|------|---------|---------|---------|-----------|
| **system_admin** | ✅ | ✅ | ✅ | ✅ |
| **mold_developer** | ✅ | ✅ | ✅ | ✅ |
| **maker** | ❌ | ❌ | ✅ | ✅ |
| **plant** | ✅ | ✅ | ✅ | ❌ |

---

## 📊 구현된 기능

### QR 스캔 페이지
- ✅ QR 코드 입력 폼
- ✅ 실시간 검증 및 세션 생성
- ✅ 금형 정보 카드 표시
- ✅ 상태 배지 (in_production, maintenance, etc.)
- ✅ 생산처 정보
- ✅ GPS 위치 이탈 경고
- ✅ 가능한 작업 버튼 동적 생성
- ✅ 한글 라벨 매핑
- ✅ 에러 처리 및 로딩 상태

### 일상점검 페이지
- ✅ 세션 ID 검증
- ✅ 금형 ID 쿼리 파라미터
- ✅ 생산수량 입력 (숫자)
- ✅ NG 수량 입력 (숫자)
- ✅ 특이사항 메모 (textarea)
- ✅ 폼 검증
- ✅ 백엔드 API 호출
- ✅ 성공/에러 메시지
- ✅ 자동 리다이렉트
- ✅ 취소 버튼

### 정기점검 페이지
- ✅ 세션 ID 검증
- ✅ 금형 ID 쿼리 파라미터
- ✅ 주기 선택 (20K/100K/400K/800K)
- ✅ 측정값 입력 (소수점)
- ✅ 기준값 입력 (min/max)
- ✅ 특이사항 메모
- ✅ 폼 검증
- ✅ 백엔드 API 호출
- ✅ NG 자동 판정 (서버)
- ✅ 성공/에러 메시지
- ✅ 자동 리다이렉트
- ✅ 취소 버튼

---

## 🎨 UI/UX 특징

### 디자인 시스템
- **배경**: Slate-900 (다크 테마)
- **카드**: Slate-950/80 (반투명)
- **테두리**: White/10 (미세한 경계)
- **강조색**: Sky-500 (파란색)
- **성공**: Emerald-300 (녹색)
- **경고**: Amber-300 (주황색)
- **에러**: Red-400 (빨간색)

### 인터랙션
- ✅ 호버 효과 (버튼, 입력 필드)
- ✅ 포커스 링 (접근성)
- ✅ 로딩 상태 표시
- ✅ 비활성화 상태
- ✅ 부드러운 전환 (transition-all)
- ✅ 그림자 효과 (shadow-2xl)

### 반응형
- ✅ 모바일 최적화 (px-4, py-8)
- ✅ 최대 너비 제한 (max-w-xl)
- ✅ 그리드 레이아웃 (grid-cols-2, grid-cols-3)
- ✅ 플렉스 박스 (flex, flex-wrap)

---

## 🧪 테스트 시나리오

### 시나리오 1: 일상점검 전체 플로우

```
1. 로그인: plant_user / password123
2. 대시보드 진입: /dashboard/plant
3. QR 스캔 이동: /qr/scan
4. QR 입력: M2024-001-PLANT-A-QR
5. 조회 버튼 클릭
6. 금형 정보 확인:
   - 코드: M2024-001
   - 상태: in_production
   - 생산처: 부산 1공장
7. "일상점검 작성" 버튼 클릭
8. 폼 입력:
   - 생산수량: 1000
   - NG 수량: 5
   - 메모: "게이트 주변 번짐"
9. 저장 버튼 클릭
10. 성공 메시지 확인
11. 자동 리다이렉트 (1.2초 후)
```

**예상 결과**:
- ✅ 금형 타수 +1000
- ✅ NG 수량 +5
- ✅ 점검 이력 저장
- ✅ QR 세션 종료

### 시나리오 2: 정기점검 NG 케이스

```
1. QR 스캔: M2024-002-PLANT-B-QR
2. "정기점검 작성" 클릭
3. 폼 입력:
   - 주기: 20K
   - 측정값: 17.5
   - 최소값: 15.0
   - 최대값: 16.0
4. 저장 클릭
```

**예상 결과**:
- ✅ NG 판정 (17.5 > 16.0)
- ✅ 알림 생성
- ✅ 점검 이력 저장 (NG)
- ✅ 금형 상태 업데이트 가능

### 시나리오 3: 위치 이탈 경고

```
1. QR 스캔: M2024-003-PLANT-C-QR
2. GPS 위치: 35.1234, 129.5678 (등록된 생산처에서 5km 이탈)
```

**예상 결과**:
- ✅ 위치 이탈 경고 표시
- ✅ "등록된 생산처 위치에서 5.0 km 이상 이탈했습니다"
- ✅ 작업은 계속 가능
- ✅ 알림 생성

---

## 📈 성능 최적화

### API 호출
- ✅ 단일 요청으로 모든 필요 정보 조회
- ✅ 세션 기반으로 중복 조회 방지
- ✅ 에러 시 재시도 없음 (명시적 재조회 필요)

### 상태 관리
- ✅ 로컬 상태 (useState)
- ✅ 최소한의 리렌더링
- ✅ 조건부 렌더링

### 사용자 경험
- ✅ 즉각적인 피드백 (로딩, 에러, 성공)
- ✅ 자동 리다이렉트 (1.2초 딜레이)
- ✅ 취소 버튼 (언제든 이탈 가능)

---

## 🔒 보안

### 인증
- ✅ ProtectedRoute로 모든 페이지 보호
- ✅ 로그인 필요
- ✅ 토큰 자동 주입

### 검증
- ✅ 세션 ID 검증
- ✅ 금형 ID 검증
- ✅ 숫자 입력 검증 (min=0)
- ✅ 백엔드 재검증

### 권한
- ✅ 역할별 가능한 작업 제한
- ✅ 백엔드에서 최종 권한 확인

---

## 📚 관련 문서

- **API 문서**: `API_IMPLEMENTATION_SUMMARY.md`
- **통합 가이드**: `FRONTEND_API_INTEGRATION_GUIDE.md`
- **백엔드 README**: `BACKEND_README.md`
- **프론트엔드 설정**: `FRONTEND_SETUP_GUIDE.md`

---

## ✅ 완료 체크리스트

### API 클라이언트
- [x] qrApi.ts 생성
- [x] inspectionApi.ts 생성
- [x] TypeScript 타입 정의
- [x] 에러 처리

### 페이지 컴포넌트
- [x] QrScanPage.tsx 생성
- [x] DailyInspectionPage.tsx 생성
- [x] PeriodicInspectionPage.tsx 생성
- [x] 반응형 디자인
- [x] 접근성 고려

### 라우터
- [x] App.jsx 업데이트
- [x] 라우트 3개 추가
- [x] ProtectedRoute 적용

### 테스트
- [ ] QR 스캔 테스트
- [ ] 일상점검 테스트
- [ ] 정기점검 테스트
- [ ] 에러 케이스 테스트
- [ ] 위치 이탈 테스트

---

## 🚀 다음 단계

### Phase 3: 수리요청 시스템
1. ⏳ 수리요청 생성 페이지
2. ⏳ 파일 업로드 (사진 최대 5장)
3. ⏳ 수리요청 승인/반려
4. ⏳ 수리요청 배정
5. ⏳ 진행 상태 업데이트
6. ⏳ 귀책 협의

### Phase 4: GPS 위치
1. ⏳ 금형 위치 지도
2. ⏳ 실시간 위치 추적
3. ⏳ 위치 이력

---

**작성일**: 2025-12-02 16:41
**상태**: ✅ Phase 2 완료
**진행률**: 8/18 APIs (44%)
**다음**: Phase 3 - 수리요청 시스템
